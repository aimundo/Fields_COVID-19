---
title: "Covid-19 Fields Survey Data Protocol"
author:
  - name: Ariel Mundo Ortiz
    orcid: 0000-0002-6014-4538
    email: ariel.mundo.ortiz@umontreal.ca
    affiliations:
      - name: École de santé publique - Université de Montréal
        address: 7101 Park Avenue
        city: Montreal
        state: QC
        postal-code: H3N 1X9
date: "`r Sys.Date()`"
format:
  pdf:
    link-citations: true
    number-sections: true
    include-in-header: 
      text: |
        \usepackage{placeins}
  html:
    toc: true
editor: visual
bibliography: bibliography/refs.bib
keep-tex: true
csl: bibliography/jama.csl
knitr:
  opts_chunk:
    dev: "ragg_png"
---

```{r, load-prepare-data}
#| echo: false
#| warning: false
#| message: false


#load packages

library(weights)
library(here)
library(survey)
library(magrittr)
library(tidyverse)
library(lme4)
library(kableExtra)
library(modelsummary)
library(gtsummary)
library(patchwork)

data<-read.csv(here("data","clean_dataset.csv"))

# remove rows with missing observations for race

clean_data<-data%>%drop_na(race)

#remove "municipal status" as is not part of the analysis (to avoid unexpected errors)

clean_data<-clean_data %>%
  select(-Municipal.status) %>%
  rename(Race=race,Age_group=age_group,Income=income_ord)

#make variables of interest factors
clean_data<-clean_data %<>%
  mutate_at(c("Income","Race","Age_group","Health_Region"),factor)

# recode the response of interest for categorical analysis
clean_data<-clean_data %>%
  mutate(first_dose_m=case_when(
    first_dose=="yes"~1,
    first_dose=="no"~0
  ))

#get health regions to eliminate
clean_data <-clean_data %>%
   filter(Health_Region!="North East" , Health_Region!="North West")
 

#eliminate the levels of the removed health regions
clean_data <- droplevels(clean_data)

## relevel for reference groups in the model

 clean_data<- within(clean_data, Age_group <- relevel(Age_group, ref = "16_24"))
 clean_data<- within(clean_data, Race <- relevel(Race, ref = "white_caucasian"))
 clean_data<- within(clean_data, Health_Region <- relevel(Health_Region, ref = "Toronto"))
 clean_data<- within(clean_data, Income <- relevel(Income, ref = "over_90000"))
 
# get percentages to see how different the data is from the Census (details of the Census values are in
# Data_cleaning_and_covariates_Jan_05.qmd in directory "data cleaning")


##### Summary of the dataset####

data_summary<-clean_data %>%
  tbl_summary(percent="row",
    by= first_dose,
    include=c(Income,
    Age_group,
    Health_Region,
    Race)
  ) %>% bold_labels()

# Each of these dataframes provide the population totals for the different variables and their categories

# clean_data %>%
#   tbl_summary(
#     include=c(
#     Health_Region,)
#   ) %>% bold_labels()


Ages<-data.frame(Age_group=c("16_24",
                             "25_34",
                             "35_44",
                             "45_54",
                             "55_64",
                             "65_and_over"),
                 Freq=c(1707959,
                        1734856,
                        1721407,
                        2003826,
                        1842444,
                        2245898))



Races<-data.frame(Race=c("arab_middle_eastern",
                         "black",
                         "east_asian_pacific_islander",
                         "indigenous",
                         "latin_american",
                         "mixed",
                         "other",
                         "south_asian",
                         "white_caucasian"),
                  Freq=c(212782,
                         638346,
                         886592,
                         376558,
                         197020,
                         130033,
                         705333,
                         1166361,
                         9118079 ))

Incomes<-data.frame(Income=c("under_15000",
                                     "15000_24999",
                                     "25000_39999",
                                     "40000_59999",
                                     "60000_89999",
                                     "over_90000"),
                        Freq=c(294643,
                               387688,
                               599624,
                               796052,
                               1007988,
                               2083176
                               
                        ))


# corrections for health regions

Health_Regions<-data.frame(Health_Region=c(
  #"North West",
  #"North East",
  "West",
  "East",
  "Central",
  "Toronto"),
  Freq=c(#232299,
    #557000,
    4095589,
    3742520,
    5032410,
    1440644
  )
)

# probably best strategy is to remove the North West and North East regions as they only constitute 5% of the total population of Ontario.

### Raking ####

## First, provide a survey design object. This is done using the dataset. The syntax
## means that there is no stratification (id=~1). When the line below is run it will throw
## a warning because we do not have "design" weights in the dataset (other datasets do have this).


a1<-svydesign(id=~1,data=clean_data)

## because there are no sampling weights, each observation as a probability of 1 of being sampled at this stage. 

#a1$prob #all probs are 1

## The next line uses the survey design object a1, and the variables we will adjust for, with the population corrections
## from the data frames from above.

a1_rake<-rake(a1,
             sample=list(~Age_group,
                         ~Race,
                         ~Income,
                         ~Health_Region),
             population=list(Ages,
                             Races,
                             Incomes,
                             Health_Regions))


```

# Background

The COVID-19 pandemic continues around the world with more than 600 million confirmed cases as of November of 2022 [@WHO-Covid]. During the first months of the pandemic in early 2020, non-pharmaceutical interventions (e.g., masking, social distancing) were the only methods available to manage the spread of the disease, but the rapid development of vaccines against the virus permitted their approval and use in some countries towards the last month part of 2020. For example, in the US and Canada vaccine campaigns began in mid-December of 2020 [@tanne2020; @bogoch2022]. Although it has been estimated that vaccines against COVID-19 have prevented around 14 millions of deaths worldwide [@watson2022], the rollout of COVID-19 vaccines has faced multiple challenges since its inception.

In this regard, vaccination efforts have faced multiple: Inequalities with regard to vaccine access due to socio-economic factors, vaccine hesitancy, and differences in vaccination rates across different segments of the population are among the challenges identified in the administration of COVID-19 vaccines [@gerretsen2021; @nafilyan2021; @malik2020]. In the case of Canada, lower vaccine uptake has been associated with socio-economic factors such as younger age, educational level, presence of children in the household, lack of a regular healthcare provider, ethnic origin, and financial instability [@guay2022; @muhajarine2021; @carter2022].

Additionally, it has been shown that geography also plays a crucial role in vaccination rates, as they vary due to spatial differences in attitudes towards vaccination [@malik2020], geographical differences in vaccine access and supply, vaccination location availability, and lack of prioritization of vulnerable groups [@bogoch2022; @nguyen2021].

Studies that analyze geographical variations in vaccine uptake can help inform public health decision-makers to design policies to that are aimed at addressing vaccination disparities. In this regard, previous geographical (spatial) analyses of vaccination rates have shown that variations in vaccine uptake can occur within small governmental administrative units (e.g., counties in the case of the US) [@mollalo2021; @yang2022; @tiu2022; @bhuiyan2022], and that geographical analyses can be predictive of booster uptake patterns [@wood2022].

In Canada, studies that have used a spatial approach to analyze vaccine uptake have shown disparities in vaccination rates across low and high income neighborhoods in the city of Toronto [@choi2021], among adolescents from deprived neighborhoods in the city of Montreal [@mckinnon2021], and highlighted disparities in vaccination status depending on age, income, and ethnic origin in all of the Canadian provinces[@guay2022]. However, to the best of our knowledge, there are no studies that have analyzed vaccination status within a province to identify inequalities that may exist within these geographical areas. A dissagregated view of variability within a province can help understand the barriers for vaccine delivery in the case of visible minorities, which have been disproportionately impacted in the pandemic [@hussain2022].

# Research Question

This study will examine self-reported COVID-19 vaccination status within the province of Ontario in order to determine how socio-economic (e.g., ethnic origin, age, income) and geographical factors (at level of the Health Regions of Ontario) influence vaccination within the province.

# Methods

## Data source: survey overview

We obtained data from the Fields Institute for Research in Mathematical Sciences' (henceforth Fields) *Survey of COVID-19 related Behaviours and Attitudes*, a repeated cross sectional survey focused on the Canadian province of Ontario which ran from Sept 30, 2021 until January 17, 2022. This survey was commissioned by Fields and the Mathematical Modelling of COVID-19 Task Force, under the supervision of Dr. Kumar Murty, the Director of Fields with funding from the Canadian Institutes of Health Research. The survey was conducted by a third-party service provider (RIWI Corp.), under ethical guidance from University of Toronto.

The survey was deployed using random domain intercept technology. Briefly, when web users clicked on a registered but commercially inactive web link or typed in a web address for a site that was dormant, they had a random chance of that link being temporarily managed by the company that administered the survey (RIWI Corp). Thus, instead of coming across a notification about the status of the site("this page does not exist"), the survey was deployed to the user. Web users then decided whether to anonymously participate, exiting the survey at any time if desired [@sargent2022].

Respondents who wished to participate were asked to select their age from a matrix of values, and subsequent questions were displayed one at a time, after the respondent confirmed their selection by answering and selecting "next". Those who do not wished to participate were asked to either close the browser window or navigate away from the domain. After the survey closed (complete or incomplete) no one from that internet protocol (IP) address could access the survey again and the domain entry point rotated such that if a respondent were to attempt to access the survey again, share the link, or enter via the same address using an alternative IP address, the survey would not render.

Additionally, respondents who indicated they were under the age of 16 were exited from the survey. No record was created in this case and due to domain cycling these users were unable to navigate back to the "age select" screen. The personal identifier information from each respondent was automatically scrubbed and replaced by a unique ID. Respondents were drawn exclusively from the province of Ontario, as per their devices meta-data.

## Survey responses

### Socio-demographic factors {#sec-socio-demographic-factors}

From the different answers provided by the survey respondents, we selected the age group which they belonged to, income bracket, race/ethnicity, and employment status. The original survey included additional questions (e.g., sick leave, remote work, presence of minors in the household) but the survey design, which permitted respondents to exit the survey at any point resulted in a high rates of missing data for most of these answers. The socio-economic factors chosen for this study were the ones that had both the lowest rates of missingness and that provided an adequate level socio-economic and demographic information for our analysis. Information about the chosen socio-economic factors from the survey is provided in @tbl-covariates.

| Variable             | Values                                                                                                                          |
|:-----------------|------------------------------------------------------|
| Age group            | 15-24,25-34,35-44,45-54,55-64, 65+                                                                                              |
| Income bracket (CAD) | \<15,000, 15,000-24,999, 25,000-39,999, 40,000-59,999, 60,000-89,999, \>90,000                                                  |
| Race/ethnicity       | Arab/Middle Eastern, Black, East Asian/Pacific Islander, Indigenous, Latin American, Mixed, South Asian, White Caucasian, other |
|                      |                                                                                                                                 |

: Selected socio-economic factors from the survey {#tbl-covariates}

### Vaccination status

From the survey, we selected the question regarding vaccination status:

-   "Have you received the first dose of the COVID vaccine?", with possible answers "yes" and "no"

<!-- -   (If answered "yes" to the previous question) "Have you received the second dose of the COVID vaccine?" with possible answers "yes" and "no" -->

<!-- -   (If answer was "no" to the first question) "If a vaccine was made available to you you would:" with possible answers "definitely get", "definitely not get", "probably get", and "probably not get" -->

<!--           - definitely get -->

<!--           - definitely not get -->

<!--           - probably get -->

<!--           - probably not get -->

## Data cleaning

The original dataset contained 39,029 entries (where each entry corresponded to a set of answers provided by a unique respondent). Following a preliminary analysis to identify the missing rates across the different answers within each entry, it was identified that many of the answers had high missing rates (\>80%) (note that the graph will be in the Appendix). Therefore, the dataset was cleaned in order to contain only the independent variables of interest with the lowest missing rates (@tbl-covariates) and the dependent variable. The final clean dataset contained 3,709 unique entries.

The cleaning process also included removing outliers that were identified during the preliminary analyses. Specifically, we removed those respondents that indicated to be below 25 years of age, living in a household of size 1, and that reported an income above CAD 110,000. After cleaning, the dataset contained 5,247 entries (each entry corresponding to a unique respondent).

### Geographical location {#sec-geographical-location}

For each survey participant certain data was automatically captured. This included the nearest municipality, which resulted in a total of 578 different municipalities within the dataset. Due to our interest in analyzing the differences between Health Regions, we assigned the location (city) of each entry to its correspondent Health Region following a multi-step process: First, we used the municipality information from the website of the Association of Municipalities of Ontario (AMO) to assign geographical regions to each entry on the dataset. Secondly, we used a publicly available dataset of long-term care homes by Local Health Integrated Network (LHIN, the previous geographical divisions for health in Ontario before the adoption of the Health Regions), to match each city with its corresponding LHIN. Cities that did not have a LHIN entry on the dataset were searched in the websites of the LHINs and manually added to the dataset. Finally, we assigned the corresponding Health Region to each city by matching the LHINs to the Health Regions that now encompass them, following the information provided by Ontario Health (details of the complete process are in the Appendix).

Following an assessment of the number of entries corresponding to each Health Region in the clean dataset, we removed entries that corresponded to the North East and North West Health Regions as they comprised only 107 observations (4.3% of the total). Due to the low number of entries in these regions, we omitted these Health Regions from further analyses. Therefore, the total number of unique entries used for analysis was 3,551 comprising the East, Central, Toronto, and West Health Regions.

## Corrections

We identified differences between the proportions of various socio-economic factors the survey respondents when compared to the 2016 Census data for Ontario. These factors included age groups, income, and ethnicity/race identified. Additionally, because the Census divisions do not match the exact boundaries of the Census, we also obtained population estimates for each Health Region from the Ontario Health website in order to correct for the population within each Health Region. We corrected for all of these factors (age group, race/ethnicity, income, Health Region Population) using an iterative proportional fitting procedure (also known as *raking*) [@deming1940] in R using the `survey` package. The proportions of each of these factors and the data from the 2016 Census Data for Ontario used for the corrections can be found in the Appendix. Of notice, because the categories provided by the survey in some cases (e.g., race/ethnicity categories) did not match the categories from the Census, we aggregated them where appropriate to obtain an approximation to the categories in the Census.

<!-- ## Geographical location {#sec-geographical-location} -->

<!-- For each survey participant certain data was automatically captured. This included the nearest municipality, which resulted in a total of 578 different municipalities within the dataset. Due to our interest in exploring vaccination status within a health region that encompasses multiple cities, we grouped the municipalities from the dataset according to the regional government aggregations provided by the Association of Municipalities of Ontario, which groups municipalities within regions, counties, districts, and single-tiers [@ontario-municipalities]. The geographical regions were obtained from the websie of the province of Ontario <https://www.ontario.ca/page/list-ontario-municipalities#section-3> -->

## Statistical model

Because of the binary outcome of the survey answer of our interest (vaccination status as "yes" or "no") we used a fixed-effects logistic regression to estimate the probability of vaccination depending on the socio-economic factors described in @sec-socio-demographic-factors and the Health Regions from @sec-geographical-location. Previous studies have shown that socio-economic factors, and their interactions are significant predictors of intent of vaccination and vaccination status [@nguyen2022; @shih2021; @cnat2022a]. At the same time in the case of Canada, others have indicated an ongoing need of socio-economic information that can provide a rationale for the disparities in vaccination observed within some racial groups [@cnat2022b].

Therefore, we built a logistic regression model that accounted for interactions between the available socio-economic factors obtained from the Fields Covid survey. The model appears in @eq-model3,

$$
\begin{aligned}
\log \left( \frac{p\textrm{(vac)}}{1-p\textrm{(vac)}} \right) = \beta_0+ \beta_{1}\textrm{(Age group)} +\beta_{2} \textrm{ Race} + \beta_3 \textrm{ Health Region} + \beta_4 \textrm{ Income}+\\ \beta_5\textrm{(Health Region} \times \textrm{Income)} + \beta_6 \textrm{ (Age group} \times \textrm{Income)} + \beta_7 \textrm{ (Race} \times \textrm{Income)}
\end{aligned}
$$ {#eq-model3}

Where $p\textrm{(vac)}$ indicates the probability of having received the first dose of a Covid-19 vaccine, $\beta_0$ indicates the population intercept, $\beta_1...\beta_7$ indicate the coefficients for each of the fixed and interaction effects of age group, race, Health Region, and income. The the model was fitted using the function `svyglm` from the `survey` R package in order to incorporate the correction in sampling probability obtained from raking.

```{r,models}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-AIC
#| tbl-cap: "AIC for the three models"

### Model ###

## the first model is a simple logistic regression with fixed effects only svyglm uses the glm
## function to calculate, so it does not allow for random effects.
# 
# model1<-svyglm(first_dose_m~Age_group+Race+Health_Region*Income+Health_Region,
#               design=a1_rake,
#               family = quasibinomial(), 
#               control= list(maxit=25))
# 
# 
# model2<-svyglm(first_dose_m~Age_group+Race+Health_Region*Income+Health_Region+Age_group*Income,
#               design=a1_rake,
#               family = quasibinomial(), 
#               control= list(maxit=25))


model3<-svyglm(first_dose_m~Age_group+Race+Health_Region*Income+Health_Region+Age_group*Income+Race*Income,
              design=a1_rake,
              family = quasibinomial(), 
              control= list(maxit=25))



# model4<-svyglm(first_dose_m~Age_group+Income+Race+Health_Region+Health_Region*Income+Income*Age_group+Income*Race+Income*Age_group*Race,
#               design=a1_rake,
#               family = quasibinomial(), 
#               control= list(maxit=25))
# 
# 
# model5<-svyglm(first_dose_m~Age_group+Income+Race+Health_Region+Health_Region*Income+Income*Age_group+Income*Race+Race*Health_Region,
#               design=a1_rake,
#               family = quasibinomial(), 
#               control= list(maxit=25))


#summary(model1.test)
#summary(model1.hr)
# 
# model_comp<-as_tibble(AIC(model1,model2,model3))%>%
#   select(-c(eff.p,deltabar))%>%
#   add_column(model=c("model1","model2","model3"))
# 
# model_comp%>%
#   kbl(booktabs=T,
#       col.names = c("AIC","model"))
#   
## helps visualize the model output


###############



```

# Results

## Descriptive statistics of the Fields Covid-19 Survey

@tbl-descriptive-stats shows the descriptive statistics (uncorrected) from the Fields Covid-19 survey data for vaccination status and each of the covariates analyzed.

```{r,summary-table}
#| label: tbl-descriptive-stats
#| tbl-cap: "Descriptive Statistics of the Fields Covid-19 Survey"
#| message: false
#| echo: false

data_summary %>%
  modify_header(label = "**Variable**") %>%
  as_kable_extra(booktabs = TRUE) %>%
  # reduce font size to make table fit. 
  # you may also use the `latex_options = "scale_down"` argument here.
  kableExtra::kable_styling(latex_options = "repeat_header",font_size = 9)

```

## Vaccination status, socio-economic and geographical variables

@tbl-model shows the results of the logistic regression on vaccination status using socio-economic, geographical factors (by Health Region) and their interactions as predictors. The reference groups in each case were set as follows:  16 to 24 years (age group), White Caucasian (Race), Toronto (Health Region), Over CAD 90,000 (Income). Socio-economic factors with statistically significant odds ratios were the age group of 65 years and over (OR=0.44), persons who identified as Arab/Middle Eastern (OR=0.15), Black (OR=0.17), Indigenous (OR=0.27), Latin American (OR=0.24), South Asian (OR=0.4) and Other Race/Ethnicity (a group  that included minorities not found elsewhere, OR=0.17), and those that lived in a household with an income bracket between CAD 25,000-39,999 (OR=0.23). 

Regarding the interaction effects, the interaction of the Central Health Region and income bracket between 15000 to 24999 CAD was statistically significant (OR=0.4). In age group and income, significant effects were estimated for those 65 years and older with a household income between CAD 25000-39999 (OR=7.21), and with an income between CAD 40000-59999 (OR=3.12). In the case of race and income, significant effects were estimated for individuals that identified as Arab/Middle Easterners with a family income between 15000 and 24999 (OR=5.68) or income under CAD 15000 (OR=4.21), Black individuals with a family income under CAD 15000 (OR=4.26) or between CAD 15000-24999 (OR=3.35); additionally, there were statistically significant interaction effects in the case of those that identified as belonging to a race not identified elsewhere ("Other") within multiple income brackets: under CAD 15000 (OR=3.73), between 15000 and 24999 (OR 11.2), between 25000 and 39999 CAD (OR=4.67), and with income CAD 40000-59999 (OR=9.58). Finally, there was a significant interaction effect for South Asian individuals with an income under CAD 15000 (OR=3.10).

```{r,model-table}
#| message: false
#| echo: false
#| label: tbl-model
#| tbl-cap: "Multiple Regression Analysis-Predictors of Vaccination Status"


# modelsummary(model3, shape=term~response)
# 
# 
# panels <- list(
#   "Health Regions" = list(
#     "(I)" = lm(mpg ~ 1, data = mtcars),
#     "(II)" = lm(mpg ~ qsec, data = mtcars)
#   ),
#   "Outcome: hp" = list(
#     "(I)" = lm(hp ~ 1, data = mtcars),
#     "(II)" = lm(hp ~ qsec, data = mtcars)
#   )
# )
# 
# modelsummary(
#   panels,
#   shape = "rbind",
#   gof_map = gm)

model3 %>%
  tbl_regression(exponentiate = TRUE,
                 label=list(Health_Region ~ "Health Region",
                 Age_group ~ "Age Group")) %>%
    bold_labels()%>%
  as_kable_extra(booktabs = TRUE, longtable=T) %>%
  # reduce font size to make table fit. 
  # you may also use the `latex_options = "scale_down" argument here.
  kableExtra::kable_styling(latex_options = "repeat_header")
```



\FloatBarrier

## References

::: {#refs}
:::
