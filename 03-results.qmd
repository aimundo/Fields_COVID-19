# Results

```{r, load-prepare-data}
#| echo: false
#| warning: false
#| message: false


#load packages

library(weights)
library(here)
library(survey)
library(magrittr)
library(tidyverse)
library(lme4)
library(kableExtra)
library(modelsummary)
library(gtsummary)
library(patchwork)

data<-read.csv(here("data","clean_dataset.csv"))

# remove rows with missing observations for race

clean_data<-data%>%drop_na(race)

#remove "municipal status" as is not part of the analysis (to avoid unexpected errors)

clean_data<-clean_data %>%
  select(-Municipal.status) %>%
  rename(Race=race,Age_group=age_group,Income=income_ord)

#make variables of interest factors
clean_data<-clean_data %<>%
  mutate_at(c("Income","Race","Age_group","Health_Region"),factor)

# recode the response of interest for categorical analysis
clean_data<-clean_data %>%
  mutate(first_dose_m=case_when(
    first_dose=="yes"~1,
    first_dose=="no"~0
  ))

#get health regions to eliminate
clean_data <-clean_data %>%
   filter(Health_Region!="North East" , Health_Region!="North West")
 

#eliminate the levels of the removed health regions
clean_data <- droplevels(clean_data)

## relevel for reference groups in the model

 clean_data<- within(clean_data, Age_group <- relevel(Age_group, ref = "16_24"))
 clean_data<- within(clean_data, Race <- relevel(Race, ref = "white_caucasian"))
 clean_data<- within(clean_data, Health_Region <- relevel(Health_Region, ref = "Toronto"))
 clean_data<- within(clean_data, Income <- relevel(Income, ref = "over_90000"))
 
# get percentages to see how different the data is from the Census (details of the Census values are in
# Data_cleaning_and_covariates_Jan_05.qmd in directory "data cleaning")


##### Summary of the dataset####

data_summary<-clean_data %>%
  tbl_summary(percent="row",
    by= first_dose,
    include=c(Income,
    Age_group,
    Health_Region,
    Race)
  ) %>% bold_labels()

# Each of these dataframes provide the population totals for the different variables and their categories

# clean_data %>%
#   tbl_summary(
#     include=c(
#     Health_Region,)
#   ) %>% bold_labels()


Ages<-data.frame(Age_group=c("16_24",
                             "25_34",
                             "35_44",
                             "45_54",
                             "55_64",
                             "65_and_over"),
                 Freq=c(1707959,
                        1734856,
                        1721407,
                        2003826,
                        1842444,
                        2245898))



Races<-data.frame(Race=c("arab_middle_eastern",
                         "black",
                         "east_asian_pacific_islander",
                         "indigenous",
                         "latin_american",
                         "mixed",
                         "other",
                         "south_asian",
                         "white_caucasian"),
                  Freq=c(212782,
                         638346,
                         886592,
                         376558,
                         197020,
                         130033,
                         705333,
                         1166361,
                         9118079 ))

Incomes<-data.frame(Income=c("under_15000",
                                     "15000_24999",
                                     "25000_39999",
                                     "40000_59999",
                                     "60000_89999",
                                     "over_90000"),
                        Freq=c(294643,
                               387688,
                               599624,
                               796052,
                               1007988,
                               2083176
                               
                        ))


# corrections for health regions

Health_Regions<-data.frame(Health_Region=c(
  #"North West",
  #"North East",
  "West",
  "East",
  "Central",
  "Toronto"),
  Freq=c(#232299,
    #557000,
    4095589,
    3742520,
    5032410,
    1440644
  )
)

# probably best strategy is to remove the North West and North East regions as they only constitute 5% of the total population of Ontario.

### Raking ####

## First, provide a survey design object. This is done using the dataset. The syntax
## means that there is no stratification (id=~1). When the line below is run it will throw
## a warning because we do not have "design" weights in the dataset (other datasets do have this).


a1<-svydesign(id=~1,data=clean_data)

## because there are no sampling weights, each observation as a probability of 1 of being sampled at this stage. 

#a1$prob #all probs are 1

## The next line uses the survey design object a1, and the variables we will adjust for, with the population corrections
## from the data frames from above.

a1_rake<-rake(a1,
             sample=list(~Age_group,
                         ~Race,
                         ~Income,
                         ~Health_Region),
             population=list(Ages,
                             Races,
                             Incomes,
                             Health_Regions))


```